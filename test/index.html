

<br />
<p>
  Copy this code:
</p>
<pre id="code"></pre>
<br />
<button id="start">Start</button>

<script type="text/javascript">

const client_id = 'a8c67fc925dfb56ca65e'

let device_code

function request(method, url, body, config = {}) {
  return fetch(url, {
    method,
    body: body && (
      typeof body === 'string'
        ? body
        : JSON.stringify(body)
    ),
    ...config
  }).then((res) => {
    return res.text()
  }).then((text) => {
    try {
      return JSON.parse(text)
    } catch {
      if (text.includes('&')) {
        const result = {}
        text.split('&').forEach((part) => {
          const [key, value] = part.split('=')
          result[key] = isNaN(value) ? decodeURIComponent(value) : Number(value)
        })
        return result
      }
      return text
    }
  })
}

function proxyRequest(method, url, body, config = {}) {
  config.headers = {
    ...(config.headers || {}),
    origin: 'http://localhost:5000',
    'Content-Type': 'application/x-www-form-urlencoded'
  }
  return request(method, `https://cors-anywhere.herokuapp.com/${url}`, body, config)
}


(async function() {
  const body = `client_id=${client_id}&scope=repo`
  const res = await proxyRequest('POST', 'https://github.com/login/device/code', body)
  //const res = await request('GET', 'https://api.github.com/user')
  console.log(res)
  device_code = res.device_code
  document.getElementById('code').innerHTML = res.user_code
  setTimeout(() => {
    
  }, 1000)
})();

async function start() {
  const popup = window.open('https://github.com/login/device', '', "width=400,height=600")
  const timer = setInterval(() => { 
    if(popup.closed) {
      clearInterval(timer);
      check()
    }
  }, 500);
}
document.getElementById('start').addEventListener('click', () => {
  start()
})

async function check() {
  const body = `client_id=${client_id}&device_code=${device_code}&grant_type=urn:ietf:params:oauth:grant-type:device_code`
  const res = await proxyRequest('POST', 'https://github.com/login/oauth/access_token', body)
  console.log(res)
}
</script>

